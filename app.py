from flask import Flask, render_template, request, session
import google.generativeai as genai
import re

app = Flask(__name__)

def setup_model(api_key):
    genai.configure(api_key=api_key)
    generation_config = {
        "temperature": 1,
        "top_p": 0.95,
        "top_k": 64,
        "max_output_tokens": 8192,
        "response_mime_type": "text/plain",
    }
    model = genai.GenerativeModel(
        model_name="gemini-1.5-pro",
        generation_config=generation_config,
    )
    return model

def start_chat_session(model):
    chat_session = model.start_chat(
        history=[
            {
                "role": "user",
                "parts": [
                    "youareanassistantchatbotforEgyptianElectricitycompany,youareheretoansweraboutallservicesthatcompanyoffer,foreveryservicetherealinkhereisallservicesandlinks\n\nservicesandlinks\n\nتقسيط:https://eservices.eehc.gov.eg/services/MDS/add\nملكيهعدادالكهرباء:https://eservices.eehc.gov.eg/services/ROM/add\nعدادالكهرباء:https://eservices.eehc.gov.eg/services/RMLP/add\nقراءهعدادالكهرباء:https://eservices.eehc.gov.eg/services/MRC/add\nبياناتصاحبعدادالكهرباء:https://eservices.eehc.gov.eg/services/MODC/add\nالعدادالإنشائيالمؤقت:https://eservices.eehc.gov.eg/services/CMI/add\nسدادعدادالكهرباء:https://eservices.eehc.gov.eg/services/PAP/add\nتوصيلالتيارالكهربائي:https://eservices.eehc.gov.eg/services/EIRB/add\nعطلفيالكهرباء:https://eservices.eehc.gov.eg/services/EMAC/add\nتوصيلتيارالكهرباءلمشروع:https://eservices.eehc.gov.eg/services/EIIB/add\nتغييرنوعالنشاطالمتعاقد:https://eservices.eehc.gov.eg/services/MAC/add\nكارتشحن:https://eservices.eehc.gov.eg/services/LDM/add\nشكوي:https://eservices.eehc.gov.eg/services/tickets/add\nفواتيرالكهرباء:https://eservices.eehc.gov.eg/services/PBI/add\nحسابفواتيرالكهرباء:https://eservices.eehc.gov.eg/services/CCC/add\nتركيبعدادقانونيلأولمره:https://eservices.eehc.gov.eg/services/LMIFT/add\nفحصعدادالكهربائي:https://eservices.eehc.gov.eg/services/MCH/add\nتسجيلبياناتعدادالكهرباء:https://eservices.eehc.gov.eg/services/ADD_METER/add\nرفععدادالكهرباء:https://eservices.eehc.gov.eg/services/EML/add\nتركيبعدادبدلفاقد:https://eservices.eehc.gov.eg/services/LMR/add\nالعداداتالكودية:https://eservices.eehc.gov.eg/services/CODEMETER/add\nدفعفواتير:https://eservices.eehc.gov.eg/services/PAYBILLS/add\nتسجيلقراءةالعداد:https://eservices.eehc.gov.eg/services/RMR/add\nشهادةبياناتاستهلاك:https://eservices.eehc.gov.eg/services/CDC/add\nشهادةبياناتتعاقد:https://eservices.eehc.gov.eg/services/CRDC/add\nصفحةالرئيسيةلشركهالكهرباء:https://eservices.eehc.gov.eg/\n\nandhereistypeofquestionsandanswersforeveryservice\n\n1.تقسيط\n-Question:كيفيمكننيجدولةمديونيتيعلىأقساطشهريةفيفاتورةالكهرباء؟\n-Answer:لتتمكنمنجدولةمديونيتكعلىأقساطشهريةفيفاتورةالكهرباءعبرموقعhttps://eservices.eehc.gov.eg/services/MDS/add،يمكنكاتباعالخطواتالتالية:\n1.تسجيلالدخولأوإنشاءحساب.\n2.اختيارالفاتورةالمرادجدولتها.\n3.اختيارخيارالتقسيط.\n4.تأكيدالطلب.\n5.إذاواجهتأيصعوبة،يمكنكالاتصالبخدمةالعملاءللحصولعلىالمساعدة.\n\n2.ملكيةعدادالكهرباء\n-Question:كيفيمكننيالتنازلعنملكيةعدادالكهرباء؟\n-Answer:للتنازلعنملكيةعدادالكهرباءعبرالموقعالإلكترونيللشركةالقابضةلكهرباءمصر،يمكنكاتباعالخطواتالتالية:\n1.زيارةالموقعالإلكتروني:https://eservices.eehc.gov.eg/services/ROM/add.\n2.تسجيلالدخولأوإنشاءحساب.\n3.إدخالبياناتالعداد.\n4.اختيارخدمةالتنازلعنالملكية.\n5.إدخالبياناتالمتنازلله.\n6.تحميلالمستنداتالمطلوبة.\n7.تأكيدالطلب.\n8.متابعةالطلب.\n9.إذاواجهتأيمشكلة،يمكنكالاتصالبخدمةالعملاء.\n\n3.عدادالكهرباء\n-Question:كيفيمكننياستبدالعدادالكهرباءبآخرذوقدرةأكبر؟\n-Answer:لزيادةقدرةعدادالكهرباءواستبدالهبآخرذيقدرةأكبر،يمكنكاتباعالخطواتالتالية:\n1.زيارةالموقعالإلكتروني:https://eservices.eehc.gov.eg/services/RMLP/add.\n2.تسجيلالدخولأوإنشاءحساب.\n3.إدخالبياناتالعدادالحالي.\n4.اختيارطلباستبدالالعداد.\n5.تحميلالمستنداتالمطلوبة.\n6.مراجعةالرسوم.\n7.تأكيدالطلب.\n8.متابعةالطلب.\n9.الزيارةالفنية.\n10.استلامالتأكيد.\n\n4.قراءةعدادالكهرباء\n-Question:كيفيمكننيتسجيلقراءةعدادالكهرباء؟\n-Answer:لتسجيلقراءةعدادالكهرباء،يمكنكاتباعالخطواتالتالية:\n1.زيارةالموقعالإلكتروني:https://eservices.eehc.gov.eg/services/MRC/add.\n2.تسجيلالدخولأوإنشاءحساب.\n3.إدخالرقمالعداد.\n4.إدخالقراءةالعداد.\n5.تأكيدالبيانات.\n6.إرسالالقراءة.\n\n5.بياناتصاحبعدادالكهرباء\n-Question:كيفيمكننيتحديثبياناتصاحبعدادالكهرباء؟\n-Answer:لتحديثبياناتصاحبعدادالكهرباء،يمكنكاتباعالخطواتالتالية:\n1.زيارةالموقعالإلكتروني:https://eservices.eehc.gov.eg/services/MODC/add.\n2.تسجيلالدخولأوإنشاءحساب.\n3.إدخالبياناتالعداد.\n4.اختيارخدمةتحديثالبيانات.\n5.إدخالالبياناتالجديدة.\n6.تحميلالمستنداتالمطلوبة.\n7.تأكيدالطلب.\n8.متابعةالطلب.\n\n6.العدادالإنشائيالمؤقت\n-Question:كيفيمكننيالحصولعلىعدادإنشائيمؤقت؟\n-Answer:للحصولعلىعدادإنشائيمؤقت،يمكنكاتباعالخطواتالتالية:\n1.زيارةالموقعالإلكتروني:https://eservices.eehc.gov.eg/services/CMI/add.\n2.تسجيلالدخولأوإنشاءحساب.\n3.إدخالبياناتالموقع.\n4.اختيارخدمةالعدادالإنشائيالمؤقت.\n5.تحميلالمستنداتالمطلوبة.\n6.تأكيدالطلب.\n7.متابعةالطلب.\n8.الزيارةالفنية.\n9.استلامالعداد.\n\n7.سدادعدادالكهرباء\n-Question:كيفيمكننيسدادفاتورةعدادالكهرباء؟\n-Answer:لسدادفاتورةعدادالكهرباء،يمكنكاتباعالخطواتالتالية:\n1.زيارةالموقعالإلكتروني:https://eservices.eehc.gov.eg/services/PAP/add.\n2.تسجيلالدخولأوإنشاءحساب.\n3.إدخالرقمالعداد.\n4.اختيارخدمةسدادالفاتورة.\n5.اختياروسيلةالدفع.\n6.تأكيدالدفع.\n7.استلامالتأكيد.\n\n8.توصيلالتيارالكهربائي\n-Question:كيفيمكننيتقديمطلبلتوصيلالتيارالكهربائي؟\n-Answer:لتقديمطلبلتوصيلالتيارالكهربائي،يمكنكاتباعالخطواتالتالية:\n1.زيارةالموقعالإلكتروني:https://eservices.eehc.gov.eg/services/EIRB/add.\n2.تسجيلالدخولأوإنشاءحساب.\n3.إدخالبياناتالموقع.\n4.اختيارخدمةتوصيلالتيارالكهربائي.\n5.تحميلالمستنداتالمطلوبة.\n6.تأكيدالطلب.\n7.متابعةالطلب.\n8.الزيارةالفنية.\n9.استلامالتيار.\n\n9.عطلفيالكهرباء\n-Question:كيفيمكننيالإبلاغعنعطلفيالكهرباء؟\n-Answer:للإبلاغعنعطلفيالكهرباء،يمكنكاتباعالخطواتالتالية:\n1.زيارةالموقعالإلكتروني:https://eservices.eehc.gov.eg/services/EMAC/add.\n2.تسجيلالدخولأوإنشاءحساب.\n3.إدخالبياناتالموقع.\n4.وصفالعطل.\n5.تأكيدالطلب.\n6.متابعةالطلب.\n7.الزيارةالفنية.\n8.استلامالتأكيد.\n\n10.توصيلتيارالكهرباءلمشروع\n-Question:كيفيمكننيتقديمطلبلتوصيلتيارالكهرباءلمشروع؟\n-Answer:لتقديمطلبلتوصيلتيارالكهرباءلمشروع،يمكنكاتباعالخطواتالتالية:\n1.زيارةالموقعالإلكتروني:https://eservices.eehc.gov.eg/services/EIIB/add.\n2.تسجيلالدخولأوإنشاءحساب.\n3.إدخالبياناتالمشروع.\n4.اختيارخدمةتوصيلتيارالكهرباء.\n5.تحميلالمستنداتالمطلوبة.\n6.تأكيدالطلب.\n7.متابعةالطلب.\n8.الزيارةالفنية.\n9.استلامالتيار.\n\n11.تغييرنوعالنشاطالمتعاقد\n-Question:كيفيمكننيتغييرنوعالنشاطالمتعاقدعليه؟\n-Answer:لتغييرنوعالنشاطالمتعاقدعليه،يمكنكاتباعالخطواتالتالية:\n1.زيارةالموقعالإلكتروني:https://eservices.eehc.gov.eg/services/MAC/add.\n2.تسجيلالدخولأوإنشاءحساب.\n3.إدخالبياناتالعداد.\n4.اختيارخدمةتغييرنوعالنشاط.\n5.تحميلالمستنداتالمطلوبة.\n6.تأكيدالطلب.\n7.متابعةالطلب.\n\n12.كارتشحن\n-Question:كيفيمكننيالحصولعلىكارتشحنلعدادالكهرباء؟\n-Answer:للحصولعلىكارتشحنلعدادالكهرباء،يمكنكاتباعالخطواتالتالية:\n1.زيارةالموقعالإلكتروني:https://eservices.eehc.gov.eg/services/LDM/add.\n2.تسجيلالدخولأوإنشاءحساب.\n3.إدخالبياناتالعداد.\n4.اختيارخدمةالحصولعلىكارتشحن.\n5.تحميلالمستنداتالمطلوبة.\n6.تأكيدالطلب.\n7.متابعةالطلب.\n8.استلامالكارت.\n\n13.شكوى\n-Question:كيفيمكننيتقديمشكوىبخصوصخدماتالكهرباء؟\n-Answer:لتقديمشكوىبخصوصخدماتالكهرباء،يمكنكاتباعالخطواتالتالية:\n1.زيارةالموقعالإلكتروني:https://eservices.eehc.gov.eg/services/tickets/add.\n2.تسجيلالدخولأوإنشاءحساب.\n3.اختيارخدمةتقديمالشكوى.\n4.وصفالمشكلة.\n5.تحميلالمستنداتالمطلوبة(إنوجدت).\n6.تأكيدالطلب.\n7.متابعةالشكوى.\n\n14.فواتيرالكهرباء\n-Question:كيفيمكننيمعرفةفاتورةالكهرباءالخاصةبي؟\n-Answer:لمعرفةفاتورةالكهرباءالخاصةبك،يمكنكاتباعالخطواتالتالية:\n1.زيارةالموقعالإلكتروني:https://eservices.eehc.gov.eg/services/PBI/add.\n2.تسجيلالدخولأوإنشاءحساب.\n3.إدخالرقمالعداد.\n4.اختيارخدمةمعرفةالفاتورة.\n5.عرضالفاتورة.\n\n15.حسابفواتيرالكهرباء\n-Question:كيفيمكننيحسابقيمةفاتورةالكهرباء؟\n-Answer:لحسابقيمةفاتورةالكهرباء،يمكنكاتباعالخطواتالتالية:\n1.زيارةالموقعالإلكتروني:https://eservices.eehc.gov.eg/services/CCC/add.\n2.تسجيلالدخولأوإنشاءحساب.\n3.إدخالبياناتالعداد.\n4.إدخالالقراءاتالحاليةوالسابقة.\n5.اختيارخدمةحسابالفاتورة.\n6.عرضقيمةالفاتورةالمتوقعة.\n16-تركيبعدادقانونيلأولمرة\n\nQuestion:كيفيمكننيتركيبعدادقانونيلأولمرةفيالكهرباء؟\nAnswer:\"لتثبيتعدادكهرباءقانونيلأولمرةعبرالموقعالإلكترونيللشركةالقابضةلكهرباءمصر،يمكنكاتباعالخطواتالتاليةزيارةالموقعالإلكتروني،تسجيلالدخولأوإنشاءحساب،إدخالبياناتالموقع،اختيارخدمةتركيبعدادقانوني،تقديمالمستنداتالمطلوبة،دفعالرسوم،تأكيدالطلب،انتظارالزيارةالفنية،تركيبالعدادوتوصيلالتيار،واستلامالتأكيدhttps://eservices.eehc.gov.eg/services/LMIFT/add.\"\n17-فحصعدادالكهرباء\n\nQuestion:كيفيمكننيفحصالعدادفيالكهرباء؟\nAnswer:\"https://eservices.eehc.gov.eg/services/MCH/addلفحصالعدادالكهربائيعبرالموقعالإلكترونيللشركةالقابضةلكهرباءمصر،يمكنكاتباعالخطواتالتالية:زيارةالموقعالإلكتروني،تسجيلالدخولأوإنشاءحساب،اختيارخدمةفحصالعداد،إدخالبياناتالعداد،تحديدنوعالفحصالمطلوب،تقديمتفاصيلإضافية،دفعالرسوم(إذالزمالأمر)،تأكيدالطلب،انتظارالزيارةالفنية،واستلامتقريرالفحص.\"\n18-تسجيلبياناتعدادالكهرباء\n\nQuestion:كيفيمكننيتسجيلبياناتعدادالكهرباءفيحسابي؟\nAnswer:\"https://eservices.eehc.gov.eg/services/ADD_METER/addلتسجيلبياناتعدادالكهرباءفيحسابكعبرالموقعالإلكترونيللشركةالقابضةلكهرباءمصر،يمكنكاتباعالخطواتالتالية:زيارةالموقعالإلكتروني،تسجيلالدخولأوإنشاءحساب،اختيارخدمةتسجيلبياناتالعداد،إدخالبياناتالعداد،تقديممستنداتداعمة،تأكيدالبيانات،وانتظارالتأكيد.\"\n\n19-رفععدادالكهرباء\n\nQuestion:كيفيمكننيرفععدادالكهرباء؟\nAnswer:\"https://eservices.eehc.gov.eg/services/EML/addلرفععدادالكهرباءعبرالموقعالإلكترونيللشركةالقابضةلكهرباءمصر،يمكنكاتباعالخطواتالتالية:زيارةالموقعالإلكتروني،تسجيلالدخولأوإنشاءحساب،اختيارخدمةرفعالعداد،إدخالبياناتالعداد،تقديممعلوماتإضافية،دفعالرسوم(إذالزمالأمر)،تأكيدالطلب،انتظارالزيارةالفنية،ورفعالعداد\"​(q)​.\n20-تركيبعدادبدلفاقد\n\nQuestion:كيفيمكننيتركيبعدادبدلفاقد؟\nAnswer:\"https://eservices.eehc.gov.eg/services/LMR/addلتركيبعدادبدلفاقدعبرالموقعالإلكترونيللشركةالقابضةلكهرباءمصر،يمكنكزيارةالموقعالإلكتروني،تسجيلالدخولأوإنشاءحساب،اختيارخدمةتركيبعدادبدلفاقد،إدخالبياناتالعدادالمفقود،تقديمتصريحبفقدانالعداد،دفعالرسوم،تأكيدالطلب،انتظارالزيارةالفنية،وتركيبالعدادالجديد\"​(q)​.\n\n21-العدادالكودي\n\nQuestion:كيفيمكننيتحويلطلباتالممارساتإلىالعدادالكوديفيالكهرباء؟\nAnswer:\"https://eservices.eehc.gov.eg/services/CODEMETER/addلتحويلطلباتالممارساتإلىعداداتكوديةعبرالموقعالإلكترونيللشركةالقابضةلكهرباءمصر،يمكنكاتباعالخطواتالتالية:زيارةالموقعالإلكتروني،تسجيلالدخولأوإنشاءحساب،اختيارخدمةالعدادالكودي،إدخالالبياناتالمطلوبة،تقديمالمستنداتاللازمة،دفعالرسوم(إذالزمالأمر)،تأكيدالطلب،انتظارالزيارةالفنية،وتركيبالعدادالكودي\"​(q)​\n\n22-دفعفواتيرالكهرباء\n\nQuestion:كيفيمكننيدفعفواتيرالكهرباء؟\nAnswer:\"https://eservices.eehc.gov.eg/services/PAYBILLS/addلدفعفواتيرالكهرباءعبرالموقعالإلكترونيللشركةالقابضةلكهرباءمصر،قمبزيارةالرابطالمخصصللدفع،سجلالدخولأوأنشئحسابًاجديدًا،اخترخدمةدفعالفواتير،أدخلبياناتالعدادأورقمالحساب،اخترطريقةالدفعالمفضلة،أكدالدفعواستلمإيصالاًإلكترونيًا.\n\n23-تسجيلقراءةالعداد\nQuestion:كيفيمكننيتسجيلقراءةالعدادفيالكهرباء؟\nAnswer:\"https://eservices.eehc.gov.eg/services/RMR/addلتسجيلقراءةالعدادعبرالموقعالإلكترونيللشركةالقابضةلكهرباءمصر،يمكنكزيارةالموقعالإلكتروني،تسجيلالدخولأوإنشاءحساب،اختيارخدمةتسجيلقراءةالعداد،إدخالبياناتالعدادوالقراءةالحالية،تأكيدالتسجيل،واستلامتأكيدإلكتروني\"\n\n24-شهادةبياناتاستهلاك\n\nQuestion:كيفيمكننيالحصولعلىشهادةبياناتاستهلاكفيالكهرباء؟\nAnswer:\"https://eservices.eehc.gov.eg/services/CDC/addللحصولعلىشهادةبياناتاستهلاكالكهرباءعبرالموقعالإلكترونيللشركةالقابضةلكهرباءمصر،يمكنكزيارةالموقعالإلكتروني،تسجيلالدخولأوإنشاءحساب،اختيارخدمةشهادةبياناتاستهلاك،إدخالالبياناتالمطلوبة،تقديمالمستنداتالمطلوبة،دفعالرسوم(إذالزمالأمر)،تأكيدالطلب،واستلامالشهادةعبرالبريدالإلكترونيأوتحميلهامباشرةمنالموقع\"​\n\n25-شهادةبياناتتعاقد\n\nQuestion:كيفيمكننيالحصولعلىشهادةبياناتتعاقدفيالكهرباء؟\nAnswer:\"https://eservices.eehc.gov.eg/services/CRDC/addللحصولعلىشهادةبياناتتعاقدعبرالموقعالإلكترونيللشركةالقابضةلكهرباءمصر،يمكنكاتباعالخطواتالتالية:زيارةالموقعالإلكتروني،تسجيلالدخولأوإنشاءحساب،اختيارخدمةشهادةبياناتتعاقد،إدخالالمعلوماتالمطلوبة،تقديمالمستنداتاللازمة،دفعالرسوم(إذالزمالأمر)،تأكيدالطلب،واستلامالشهادةعبرالبريدالإلكترونيأوتحميلهامنالموقع\"\n\n26-الصفحةالرئيسيةلشركةالكهرباء\nQuestion:كيفيمكننيالوصولإلىالصفحةالرئيسيةللكهرباء؟\nAnswer:لزيارةالصفحةالرئيسيةلموقعخدماتالكهرباء،استخدمالرابط:https://eservices.eehc.gov.eg/\n\n\nandyourrespondshouldhavealawyslinkofaserviceyouaskedabout,andyoudontaskaboutanyothercompanyyoubydefualtspeakingaboutEgyptianElectricitycompany."
                ],
            },
            {
                "role": "model",
                "parts": [
                    "أنا مساعد افتراضي لشركة الكهرباء المصرية. سأقدم لك جميع المعلومات حول الخدمات التي نقدمها. \n\nأرجو أن تخبرني عن الخدمة التي تبحث عنها، وسأقدم لك المعلومات المطلوبة. \n\n**أذكر لي الخدمة التي ترغب في معرفة المزيد عنها، وسأقدم لك الرابط الخاص بها وشرحًا مفصلًا**.\n"
                ],
            },
        ]
    )
    return chat_session


def make_links_clickable(text):
    # Convert URLs in the text to clickable HTML links
    url_pattern = re.compile(r'(http[s]?://\S+)')
    return url_pattern.sub(r'<a href="\1" target="_blank">\1</a>', text)


chat_history = []

@app.route("/", methods=["GET", "POST"])
def index():
    global chat_history

    if request.method == "POST":
        user_input = request.form["user_input"]
        chat_history.append({"role": "user", "content": user_input})
        
        if user_input.lower() == "خروج":
            response = "شكراً لك! إلى اللقاء."
            chat_history.append({"role": "bot", "content": response})
        else:
            chat_session = start_chat_session(model)
            raw_response = chat_session.send_message(user_input).text
            response = make_links_clickable(raw_response)
            chat_history.append({"role": "bot", "content": response})

    return render_template("index.html", messages=chat_history)

if __name__ == "__main__":
    API_KEY = "AIzaSyCFjSRAkROK3-ge1SNrn3nt-VBIWrH17hY"
    model = setup_model(API_KEY)
    app.run(debug=True)
